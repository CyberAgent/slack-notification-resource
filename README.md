Slack notification sending resource
===================================

Provides a Sends messages to Slack resource for concourse CI.

## What is the difference with [cloudfoundry-community/slack-notification-resource](https://github.com/cloudfoundry-community/slack-notification-resource)
- The difference with origin is to notify thread function!
    - There is a limit to this function

Resource Type Configuration
---------------------------

```yaml
resource_types:
- name: slack-notification
  type: docker-image
  source:
    repository: watawuwu/slack-notification-resource
    tag: latest
```

Source Configuration
--------------------

To setup an [OAuth2.0](https://api.slack.com/docs/oauth).

- `token`: *Required.* The OAuth Access Token as provided by Slack. Usually in the form: `https://api.slack.com/apps/{app-id}/oauth?`

```yaml
resources:
- name: notification
  type: slack-notification
  source:
    token: xoxp-xxxxxxxxxx-xxxxxxxxxxx-xxxxxxxxxxxx-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

Behavior
--------
### `in`: Get the thread_ts

Get the `thread_ts` of the last sent message.

*Limitations*

The last `thread_ts` is held for each resource, and it is not held for each job.
If multiple jobs are sent at the same time, the `thread_ts` sent last is acquired.

Although you can avoid it by defining resource per job, I do not recommend it.

#### Additional files populated

- `.thread_ts`: the `thread_ts` of the last sent message

### `out`: Sends message to Slack

Send message to Slack, with the configured parameters.

#### Parameters

Required:

One or more of the following:
- `attachments`: An array of one or more message attachments. See the [Slack documentation on message attachments](https://api.slack.com/docs/message-attachments) for the message structure.
- `attachments_file`: File that contains the json attachments array to send. This parameter allows the attachments to be generated by a previous task step in the Concourse job.

If you omit the `attachments` parameter, the contents of the file specified in the
`attachments_file` parameter will be used verbatim.  If the `attachments` parameter
is set, then `attachments_file` will be ignored.  There is no way to use both at the
same time.

Optional:

- `channel`: *Optional.* Override channel to send message to. `#channel` and `@user` forms are allowed. You can notify multiple channels separated by whitespace, like `#channel @user`.
- `channel_file`: *Optional.* File that contains a list of channels to send message to. If `channel` is also specified, the two lists will be concatenated.
- `username`: *Optional.* Override name of the sender of the message.
- `icon_url`: *Optional.* Override icon by providing URL to the image.
- `icon_emoji`: *Optional.* Override icon by providing emoji code (e.g. `:ghost:`).
- `thread_ts_file`: *Optional.* Sends message to thread.
- `reply_broadcast`: *Optional.* A message thread's reply was broadcast to a channel.(**experimental**)

Explore formatting with Slack's [Message Builder](https://api.slack.com/docs/formatting/builder).

#### Metadata

Various metadata is available in the form of environment variables.
Any environment variables present in the parameters will be automatically evaluated; this enables dynamic parameter content.

The following pipeline config snippet demonstrates how to incorporate the metadata:

```yaml
---
jobs:
- name: some-job
  plan:
  - put: notification
    params:
      channel: '#my_channel'
      attachments: |
        [{
          "color": "good",
          "title": "Some good news",
          "title_link": "https://$CONCOUR_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME",
          "text": "It's nice weather again today!!"
        }]
```

See the [official documentation](http://concourse.ci/implementing-resources.html#resource-metadata) for a complete list of available metadata.

Examples
--------

If you're interested in the API of Concourse resources and/or contributing to this resource, you can play with the `out` script using examples. There are some available in the `test` folder.

Note: they have a `params.debug` set so that it only prints out the data structures rather than attempting to invoke the Slack API. Remove it and set a real Slack API to test the script against Slack.

```
$ export CHANNEL=xxx
$ export TOKEN=xxx
$ cat > test.json
{
  "params": {
    "channel": "${CHANNEL}",
    "attachments": "[{\"text\": \"test\"}]"
  },
  "source": {
    "token": "${TOKEN}"
  }
}

> cat test.json | ./bin/debug/out .

```
